---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";

// Cargamos la configuraci√≥n desde las variables de entorno (.env)
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
};
---

<Layout title="Login | Adminynot">
  <section
    class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center px-4"
  >
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-gray-800 text-center">
        Iniciar sesi√≥n
      </h1>
      <form class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Correo electr√≥nico
          </label>
          <input
            type="email"
            placeholder="tucorreo@email.com"
            class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Contrase√±a
          </label>
          <input
            type="password"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200"
        >
          Iniciar sesi√≥n
        </button>
      </form>
    </div>
  </section>

  <!-- Inyectamos la config de Firebase en el DOM de forma segura -->
  <script
    type="application/json"
    id="firebase-config"
    set:html={JSON.stringify(firebaseConfig)}
  />

  <!-- Script de autenticaci√≥n con Firebase -->
  <script type="module">
    const configScript = document.getElementById("firebase-config");
    const firebaseConfig = JSON.parse(configScript.textContent);
    console.log("üì¶ Config Firebase le√≠da desde el DOM:", firebaseConfig);

    import("https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js").then(
      ({ initializeApp }) => {
        import(
          "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"
        ).then(({ getAuth, signInWithEmailAndPassword }) => {
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);

          console.log("üî• Firebase inicializado correctamente");

          document
            .querySelector("form")
            ?.addEventListener("submit", async (e) => {
              e.preventDefault();

              const email = document.querySelector('input[type="email"]').value;
              const password = document.querySelector(
                'input[type="password"]'
              ).value;

              console.log("üì® Intentando login con:", { email });

              try {
                const userCredential = await signInWithEmailAndPassword(
                  auth,
                  email,
                  password
                );
                console.log("‚úÖ Usuario autenticado:", userCredential.user);
                window.location.href = "/dashboard";
              } catch (error) {
                console.error("‚ùå Error al iniciar sesi√≥n:", error);
                alert("Error al iniciar sesi√≥n: " + error.message);
              }
            });
        });
      }
    );
  </script>
</Layout>
