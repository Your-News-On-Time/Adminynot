---
import Layout from "../components/Layout.astro";
import "../styles/global.css";

// Cargamos la configuración desde las variables de entorno (.env)
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
};
---

<Layout title="Login | Adminynot">
  <section
    class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center px-4"
  >
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-gray-800 text-center">
        Iniciar sesión
      </h1>
      
      <form class="space-y-5">
        <!-- Mensaje de error -->
        <div
          id="error-message"
          class="text-red-500 hidden text-sm text-center mb-4"
        >
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Correo electrónico</label
          >
          <input
            type="email"
            placeholder="tucorreo@email.com"
            class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Contraseña</label
          >
          <input
            type="password"
            placeholder="••••••••"
            class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200"
        >
          Iniciar sesión
        </button>
      </form>
    </div>
  </section>

  <!-- Inyectamos config Firebase como JSON en una variable global -->
  <script
    type="application/json"
    id="firebase-config"
    set:html={JSON.stringify(firebaseConfig)}
  />
  <!-- Script que la lee y la usa en cliente -->
  <script type="module">
    const configScript = document.getElementById("firebase-config");
    const firebaseConfig = JSON.parse(configScript.textContent);

    import("https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js").then(
      ({ initializeApp }) => {
        import(
          "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"
        ).then(({ getAuth, signInWithEmailAndPassword }) => {
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);

          document
            .querySelector("form")
            ?.addEventListener("submit", async (e) => {
              e.preventDefault();
              const email = document.querySelector('input[type="email"]').value;
              const password = document.querySelector(
                'input[type="password"]'
              ).value;

              // Limpiar mensaje de error previo
              const errorMessage = document.getElementById("error-message");
              errorMessage.classList.add("hidden");
              errorMessage.textContent = "";

              // Verificar primero las credenciales de emergencia
              if (email === "admin@admin.com" && password === "admin1234") {
                console.log("Acceso de emergencia autorizado");
                window.location.href = "/dashboard";
                return;
              }

              try {
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = "/dashboard";
              } catch (error) {
                console.error(
                  "Error de autenticación Firebase:",
                  error.code,
                  error.message
                );

                // Mostrar el mensaje de error correspondiente
                if (error.code === "auth/user-not-found") {
                  errorMessage.textContent = "La cuenta no está registrada en Firebase.";
                } else if (error.code === "auth/invalid-login-credentials") {
                  errorMessage.textContent = "La contraseña de Firebase es incorrecta.";
                } else if (error.code === "auth/invalid-api-key") {
                  errorMessage.textContent = "Error de configuración de Firebase. Contacta al administrador.";
                } else {
                  errorMessage.textContent =
                    "Error al iniciar sesión con Firebase. Inténtalo de nuevo.";
                }

                // Mostrar el mensaje de error en rojo
                errorMessage.classList.remove("hidden");
              }
            });
        });
      }
    );
  </script>
</Layout>
